# Network storage backends:
#   nbd
# The following testing scenarios are covered:
#   kill/reconnect a remote virtio-scsi image
#   kill/reconnect a remote virtio-blk image

- block_kill_reconnect_with_remote_storage:
    no RHEL.3.9
    only nbd
    virt_test_type = qemu
    type = block_kill_reconnect_with_remote_storage
    bootindex_image1 = 0
    images += " data1"
    boot_drive_data1 = yes
    image_size_data1 = 1G
    nbd:
        nbd_port_data1 = 10822
        force_create_image_data1 = no
        image_create_support_data1 = no
        remove_image_data1 = no
    get_disk_cmd = "ls /dev/[hsv]d[a-z]* | sort"
    disk_op_cmd = "dd if=%s of=/dev/null bs=1k count=1000 iflag=direct &&"
    disk_op_cmd += " dd if=/dev/zero of=%s bs=1k count=1000 oflag=direct"
    get_disk_cmd = "ls /dev/[hsv]d[a-z]* | sort"
    find_system_disk_cmd = "df -h | grep /boot | awk -F "[0-9] " '{print $1}'"
    find_data_disk_cmd = "ls /dev/[vhs]d* | grep -v %s"
    save_export_data_img_cmd = "ps -ef| grep -Ev 'grep|ps -ef' | grep 'qemu-nbd -t -p %s'"
    find_data_disk_pid_cmd = "ps -ef| grep -Ev 'grep|ps -ef' | grep 'qemu-nbd -t -p %s' | awk '{print $2}' | xargs kill -9"
    kill_vm = yes
    repeat_times = 3
    reconnect_time_wait = 30
    local_image_tag = data
    # commands used for break connection to nbd image
    nbd_image_tag = data1
    net_break_cmd = "iptables -I INPUT -p tcp --dport ${nbd_port_data1} -j REJECT"
    net_resume_cmd = "iptables -D INPUT -p tcp --dport ${nbd_port_data1} -j REJECT"
